<!DOCTYPE html>
<html>
<head>
    <title>Trash Route - Admin</title>
</head>
<body>
    <h1>Painel Administrativo</h1>

    <div id="adminMenu">
        <h2>Menu Admin</h2>
        <button onclick="listarPEVs()">Ver PEVs</button>
        <button onclick="mostrarFormEntrega()">Registrar Entrega</button>
        <button onclick="criarPEV()">Criar PEV</button>
        <button onclick="listarUsuarios()">Listar Usuários</button>
        <button onclick="logout()">Sair</button>

        <div id="resultado"></div>
        <ul id="listaUsuarios"></ul>
    </div>

    <div id="formPEV" style="display:none;">
        <h3>Criar Novo PEV</h3>
        <form id="pevForm">
            <input type="text" placeholder="Nome do PEV" name="nome" required>
            <input type="text" placeholder="Descrição" name="descricao">
            <input type="number" step="any" placeholder="Latitude" name="latitude" required>
            <input type="number" step="any" placeholder="Longitude" name="longitude" required>
            <button type="submit">Criar PEV</button>
            <button type="button" onclick="cancelarForm()">Cancelar</button>
        </form>
    </div>

    <div id="entregaContainer"></div>

<script>
const API_URL = 'http://localhost:3333'
const tokenTWS = localStorage.getItem('tokenTWS')

if (!tokenTWS) {
    alert('Acesso negado. Faça login como admin.')
    window.location.href = 'index.html'
}

// -------------------- FUNÇÕES DE ADMIN --------------------

async function listarUsuarios() {
    const response = await fetch(`${API_URL}/usuarios`, {
        headers: { Authorization: `Bearer ${tokenTWS}` }
    })

    if (!response.ok) {
        alert('Erro ao listar usuários')
        return
    }

    const usuarios = await response.json()
    const ul = document.getElementById('listaUsuarios')
    ul.innerHTML = ''
    usuarios.forEach(u => {
        const li = document.createElement('li')
        li.innerText = `${u.nome} | ${u.email} | ${u.role || u.isAdmin || ''}`
        ul.appendChild(li)
    })
}

async function criarPEV() {
    document.getElementById('adminMenu').style.display = 'none'
    document.getElementById('formPEV').style.display = 'block'
}

document.getElementById('pevForm').addEventListener('submit', async (e) => {
    e.preventDefault()
    const data = {
        nome: e.target.nome.value,
        descricao: e.target.descricao.value,
        latitude: parseFloat(e.target.latitude.value),
        longitude: parseFloat(e.target.longitude.value)
    }

    try {
        const response = await fetch(`${API_URL}/pevs`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${tokenTWS}`
            },
            body: JSON.stringify(data)
        })

        const result = await response.json()
        if (response.ok) {
            alert('PEV criado com sucesso!')
            e.target.reset()
            cancelarForm()
        } else {
            alert('Erro: ' + result.message)
        }
    } catch (error) {
        alert('Erro de conexão')
    }
})

function cancelarForm() {
    document.getElementById('pevForm').reset()
    document.getElementById('formPEV').style.display = 'none'
    document.getElementById('adminMenu').style.display = 'block'
}

// -------------------- FUNÇÕES DE USUÁRIO --------------------

async function listarPEVs() {
    const response = await fetch(`${API_URL}/pevs`, {
        headers: { Authorization: `Bearer ${tokenTWS}` }
    })

    if (!response.ok) {
        alert('Erro ao carregar PEVs')
        return
    }

    const result = await response.json()
    let html = ''
    result.data.forEach(pev => {
        const longitude = pev.localizacao.coordinates[0]
        const latitude = pev.localizacao.coordinates[1]
        html += `<li>
            <strong>${pev.nome}</strong><br>
            ${pev.descricao || ''}<br>
            (${latitude}, ${longitude})
        </li>`
    })

    document.getElementById('resultado').innerHTML = `<ul>${html}</ul>`
}

async function mostrarFormEntrega() {
    const response = await fetch(`${API_URL}/pevs`, {
        headers: { Authorization: `Bearer ${tokenTWS}` }
    })

    if (!response.ok) {
        alert('Erro ao carregar PEVs')
        return
    }

    const result = await response.json()
    const pevs = result.data

    let options = ''
    pevs.forEach(pev => {
        options += `<option value="${pev.id}">${pev.nome}</option>`
    })

    const html = `
        <h3>Registrar Entrega de Recicláveis</h3>
        <form id="entregaForm">
          <select name="pevId" required>
            <option value="">Selecione um PEV</option>
            ${options}
          </select>
          <input type="file" name="imagem" accept="image/*">
          <button type="submit">Registrar</button>
        </form>
    `
    document.getElementById('entregaContainer').innerHTML = html

    document.getElementById('entregaForm').addEventListener('submit', async (e) => {
        e.preventDefault()
        const formData = new FormData()
        formData.append('pevId', e.target.pevId.value)
        if (e.target.imagem.files[0]) formData.append('imagem', e.target.imagem.files[0])

        const response = await fetch(`${API_URL}/entregas`, {
            method: 'POST',
            headers: { Authorization: `Bearer ${tokenTWS}` },
            body: formData
        })

        if (response.ok) {
            alert('Entrega registrada! +10 pontos')
        } else {
            alert('Erro ao registrar entrega')
        }
    })
}

// -------------------- LOGOUT --------------------
function logout() {
    localStorage.removeItem('tokenTWS')
    window.location.href = 'index.html'
}
</script>
</body>
</html>
