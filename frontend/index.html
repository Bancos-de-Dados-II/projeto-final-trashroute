<!DOCTYPE html>
<html>
<head>
    <title>Trash Route</title>
</head>
<body>
    <h1>Trash Route - Gestão de Resíduos</h1>
    
    <div>
        <h2>Cadastro</h2>
        <form id="registerForm">
            <input type="text" placeholder="Nome" name="nome" required>
            <input type="email" placeholder="Email" name="email" required>
            <input type="password" placeholder="Senha" name="senha" required>
            <button type="submit">Cadastrar</button>
        </form>
    </div>
    
    <div>
        <h2>Login</h2>
        <form id="loginForm">
            <input type="email" placeholder="Email" name="email" required>
            <input type="password" placeholder="Senha" name="senha" required>
            <button type="submit">Entrar</button>
        </form>
    </div>
    
    <div id="loggedIn" style="display:none;">
        <h2>Área do Usuário</h2>
        <button onclick="listarPEVs()">Ver PEVs</button>
        <div id="resultado"></div>
        <button onclick="mostrarFormEntrega()">Registrar Entrega</button>
        <button onclick="logout()">Sair</button>
        <div id="entregaContainer"></div>
    </div>

<script>
const API_URL = 'http://localhost:3333'

async function listarPEVs() {
    const tokenTWS = localStorage.getItem('tokenTWS')

    const response = await fetch(`${API_URL}/pevs`, {
        method: 'GET',
        headers: { Authorization: `Bearer ${tokenTWS}` }
    })

    if (!response.ok) {
        alert('Erro ao carregar PEVs')
        return
    }

    const result = await response.json()
    let html = ''
    result.data.forEach(pev => {
        const longitude = pev.localizacao.coordinates[0]
        const latitude = pev.localizacao.coordinates[1]
        html += `<li>
            <strong>${pev.nome}</strong><br>
            ${pev.descricao || ''}<br>
            (${latitude}, ${longitude})
        </li>`
    })

    document.getElementById('resultado').innerHTML = `<ul>${html}</ul>`
}

document.getElementById('loginForm').addEventListener('submit', async (e) => {
    e.preventDefault()
    const data = { email: e.target.email.value, senha: e.target.senha.value }

    try {
        const response = await fetch(`${API_URL}/auth/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })

        if (!response.ok) {
            alert('Login falhou')
            return
        }

        const result = await response.json()
        localStorage.setItem('token', result.data.token)
        localStorage.setItem('tokenTWS', result.data.tokenTWS)
        localStorage.setItem('user', JSON.stringify(result.data.user))

        if (result.data.user.isAdmin === 's') {
            alert('Login como ADMIN realizado!')
            window.location.href = 'admin.html'
        } else {
            alert('Login realizado! (usuário comum)')
            document.getElementById('loggedIn').style.display = 'block'
            document.getElementById('loginForm').style.display = 'none'
            document.getElementById('registerForm').style.display = 'none'
        }
    } catch (error) {
        console.error('Erro no login:', error)
        alert('Erro de conexão')
    }
})

async function mostrarFormEntrega() {
    const tokenTWS = localStorage.getItem('tokenTWS')
    const response = await fetch(`${API_URL}/pevs`, {
        headers: { 'Authorization': `Bearer ${tokenTWS}` }
    })

    if (!response.ok) {
        alert('Erro ao carregar PEVs')
        return
    }

    const result = await response.json()
    const pevs = result.data
    let options = ''
    pevs.forEach(pev => {
        options += `<option value="${pev.id}">${pev.nome}</option>`
    })

    const html = `
        <h3>Registrar Entrega de Recicláveis</h3>
        <form id="entregaForm">
          <select name="pevId" required>
            <option value="">Selecione um PEV</option>
            ${options}
          </select>
          <input type="file" name="imagem" accept="image/*">
          <button type="submit">Registrar</button>
        </form>
    `

    document.getElementById('entregaContainer').innerHTML = html

    document.getElementById('entregaForm').addEventListener('submit', async (e) => {
        e.preventDefault()
        const formData = new FormData()
        formData.append('pevId', e.target.pevId.value)

        if (e.target.imagem.files[0]) {
            formData.append('imagem', e.target.imagem.files[0])
        }

        const response = await fetch(`${API_URL}/entregas`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${tokenTWS}` },
            body: formData
        })

        if (response.ok) {
            alert('Entrega registrada! +10 pontos')
        } else {
            alert('Erro ao registrar entrega')
        }
    })
}

function logout() {
    localStorage.removeItem('token')
    localStorage.removeItem('tokenTWS')
    localStorage.removeItem('user')
    window.location.href = 'index.html'
}
</script>
</body>
</html>
